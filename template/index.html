<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CrewAI Trip Planner </title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#2563eb;
    }
    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      margin: 0;
      padding: 24px;
      color: #0f172a;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin-bottom: 18px;
    }
    h1 {
      margin: 0;
      font-size: 20px;
    }
    p.lead {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 14px;
    }
    form.card {
      background: linear-gradient(180deg, rgba(255,255,255,0.9), var(--card));
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(16,24,40,0.06);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: end;
    }
    label {
      display: block;
      font-size: 13px;
      color: var(--muted);
    }
    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #e6edf3;
      font-size: 14px;
      background: transparent;
    }
    .full {
      grid-column: 1 / -1;
    }
    button.primary {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .row {
      margin-top: 18px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      align-items: start;
    }
    .summaryCard {
      background: var(--card);
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(16,24,40,0.04);
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .dayCard {
      background: linear-gradient(180deg, rgba(255,255,255,0.98), var(--card));
      padding: 16px;
      border-radius: 12px;
      border: 1px solid rgba(15,23,42,0.04);
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 120px;
    }
    .dayTitle {
      font-weight: 700;
      color: #08122b;
    }
    .daySubtitle {
      font-size: 13px;
      color: var(--muted);
    }
    .dayDetails {
      font-size: 14px;
      color: #0b1220;
      white-space: pre-wrap;
      line-height: 1.45;
    }
    .budget {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.4;
    }
    .markdown ul {
      margin: 0.4rem 0 0.6rem 1.1rem;
      padding: 0;
    }
    .markdown ol {
      margin: 0.4rem 0 0.6rem 1.1rem;
      padding: 0;
    }
    .markdown p {
      margin: 0.25rem 0;
    }
    .raw {
      background: #0b12203b;
      padding: 10px;
      border-radius: 8px;
      color: #051225;
      overflow: auto;
      max-height: 360px;
    }
    footer {
      margin-top: 26px;
      font-size: 13px;
      color: var(--muted);
      text-align: center;
    }

    /* Responsive adjustments */
    @media (max-width:720px) {
      form.card {
        grid-template-columns: 1fr;
      }
      .row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>CrewAI Trip Planner</h1>
        
      </div>
      <div style="text-align:right">
        <small class="muted">Mode: <code id="llmMode">server</code></small>
      </div>
    </header>

    <form id="tripForm" class="card">
      <div>
        <label>Destination</label>
        <input name="destination" required placeholder="e.g., Kyoto, Japan">
      </div>
      <div>
        <label>Interests</label>
        <input name="interests" placeholder="museums, food, hiking">
      </div>

      <div>
        <label>Start date</label>
        <input type="date" name="start_date">
      </div>
      <div>
        <label>End date</label>
        <input type="date" name="end_date">
      </div>

      <div class="full">
        <label>Budget</label>
        <input name="budget" placeholder="e.g., 2000 USD">
      </div>

      <div class="full" style="display:flex; justify-content:flex-end;">
        <button type="submit" class="primary">Generate itinerary</button>
      </div>
    </form>

    <div class="row">
      <div>
        <div id="itineraryArea" class="summaryCard" style="display:none;">
          <h3 style="margin:0 0 8px 0;">Suggested itinerary</h3>
          <div id="outlineText" style="color:var(--muted); font-size:14px; white-space:pre-wrap;"></div>

          <div id="cards" class="cards" style="margin-top:12px;"></div>

          <div id="budgetCard" class="summaryCard" style="margin-top:12px;"></div>

          <details style="margin-top:12px;">
            <summary>Show raw JSON result</summary>
            <pre id="rawJson" class="raw"></pre>
          </details>
        </div>
      </div>

      <aside>
        <div class="summaryCard">
          <h4 style="margin:0 0 8px 0;">Status</h4>
          <div id="statusText" class="budget">Idle</div>
          
          
        </div>
      </aside>
    </div>

    <footer>
     Roll Number : CO22353 
    </footer>
  </div>

  <script>
    const form = document.getElementById('tripForm');
    const statusText = document.getElementById('statusText');
    const itineraryArea = document.getElementById('itineraryArea');
    const outlineText = document.getElementById('outlineText');
    const cards = document.getElementById('cards');
    const budgetCard = document.getElementById('budgetCard');
    const rawJson = document.getElementById('rawJson');
    const copyBtn = document.getElementById('copyBtn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusText.textContent = 'Generating…';
      itineraryArea.style.display = 'none';
      outlineText.textContent = '';
      cards.innerHTML = '';
      budgetCard.innerHTML = '';
      rawJson.textContent = '';

      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());

      try {
        const r = await fetch('/plan', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (j.error) {
          statusText.textContent = 'Error: ' + (j.detail || JSON.stringify(j));
          return;
        }

        // fill meta
        document.getElementById('llmMode').textContent = (j.meta && j.meta.llm_mode) ? j.meta.llm_mode : 'server';

        // Render outline (convert mild markdown)
        outlineText.innerHTML = toHtml(j.outline || '');

        // Render day_details as cards, but clean up odd titles like "outline:" etc.
        cards.innerHTML = '';
        if (Array.isArray(j.day_details) && j.day_details.length) {
          j.day_details.forEach((d, idx) => {
            const dayTitle = normalizeDayTitle(d.day, idx);
            const detailsHtml = markdownToHtml(d.details || '');
            const card = document.createElement('div');
            card.className = 'dayCard';
            card.innerHTML = `<div>
                                <div class="dayTitle">${escapeHtml(dayTitle.title)}</div>
                                ${dayTitle.subtitle ? `<div class="daySubtitle">${escapeHtml(dayTitle.subtitle)}</div>` : ''}
                               </div>
                               <div class="dayDetails markdown">${detailsHtml}</div>`;
            cards.appendChild(card);
          });
        } else {
          // fallback: parse outline lines into cards
          const lines = (j.outline || '').split('\n').filter(Boolean);
          lines.forEach((line, idx) => {
            const card = document.createElement('div');
            card.className = 'dayCard';
            card.innerHTML = `<div class="dayTitle">Day ${idx+1}</div><div class="dayDetails">${escapeHtml(line)}</div>`;
            cards.appendChild(card);
          });
        }

        // Budget formatting (markdown)
        budgetCard.innerHTML = `<h4 style="margin:0 0 6px 0;">Budget</h4><div class="budget markdown">${markdownToHtml(j.budget || j['budget'] || '')}</div>`;

        rawJson.textContent = JSON.stringify(j, null, 2);

        itineraryArea.style.display = 'block';
        statusText.textContent = 'Completed';

      } catch (err) {
        statusText.textContent = 'Error: ' + err.message;
      }
    });

    // Helpers

    // Turn some markdown-like text into sanitized HTML.
    // Supports:
    // - **bold** and *italic*
    // - headings: ### or **Bold heading**
    // - lists starting with '*' (unordered) or numbered
    // - time bullets like "*   **7:00 AM - 7:30 AM: ...**" will be preserved as bold times with text
    function markdownToHtml(md) {
      if (!md && md !== 0) return '';
      // Normalize CRLF
      let text = String(md).replace(/\r\n/g, '\n');

      // Escape HTML first
      text = escapeHtml(text);

      // Convert bold **text**
      text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      // Convert italic *text* (but not bold)
      text = text.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');

      // Headings: lines starting with ### or patterns like "### Title"
      text = text.replace(/^\s*###\s*(.+)$/gm, '<h4>$1</h4>');

      // Convert lines that start with "*   " or "* " into <li>
      // We'll convert blocks of consecutive list items into <ul>
      text = text.replace(/^(?:\s*\*\s+.*\n)+/gm, function(block) {
        const items = block.trim().split(/\n/).map(line => line.replace(/^\s*\*\s+/, '').trim());
        return '<ul>' + items.map(i => `<li>${i}</li>`).join('') + '</ul>';
      });

      // Also capture numbered lists like "1. text"
      text = text.replace(/^(?:\s*\d+\.\s+.*\n)+/gm, function(block) {
        const items = block.trim().split(/\n/).map(line => line.replace(/^\s*\d+\.\s+/, '').trim());
        return '<ol>' + items.map(i => `<li>${i}</li>`).join('') + '</ol>';
      });

      // Convert double newlines to paragraph breaks
      text = text.replace(/\n\s*\n/g, '</p><p>');
      // Convert remaining newlines to <br>
      text = text.replace(/\n/g, '<br>');

      // wrap in <p> if not already containing block tags
      if (!/^<(ul|ol|h|p|div)/i.test(text.trim())) {
        text = `<p>${text}</p>`;
      } else {
        // ensure top-level text not wrapped is in div
        text = `<div>${text}</div>`;
      }

      return text;
    }

    // A simpler toHtml attempt for the outline: preserve newlines and mild markdown
    function toHtml(md){
      if(!md && md !== 0) return '';
      let t = escapeHtml(String(md));
      t = t.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      t = t.replace(/\n/g, '<br>');
      return t;
    }

    // Normalize day title text: returns object {title, subtitle}
    function normalizeDayTitle(dayField, idx){
      if(!dayField && dayField !== 0) {
        return { title: `Day ${idx+1}`, subtitle: '' };
      }
      let s = String(dayField).trim();

      // Remove leading "outline:" or "outline"
      s = s.replace(/^outline:\s*/i, '');

      // If s contains parentheses with dates, use them as subtitle
      const dateMatch = s.match(/\(([^)]+)\)/);
      let subtitle = '';
      if(dateMatch) {
        subtitle = dateMatch[1];
        s = s.replace(/\s*\([^)]+\)\s*/, '').trim();
      }

      // If the title is long (full paragraph), take first 8 words
      let title = s;
      if(title.length > 60) {
        const short = title.split(/\s+/).slice(0,8).join(' ');
        title = short + '…';
      }

      if(!title) title = `Day ${idx+1}`;

      // Clean up markdown asterisks around titles
      title = title.replace(/^\*+|\*+$/g, '').trim();

      return { title, subtitle };
    }

    function escapeHtml(unsafe) {
      if (!unsafe && unsafe !== 0) return '';
      return String(unsafe)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    copyBtn.addEventListener('click', () => {
      const text = rawJson.textContent;
      navigator.clipboard.writeText(text).then(()=> {
        copyBtn.textContent = 'Copied!';
        setTimeout(()=> copyBtn.textContent = 'Copy itinerary JSON', 1200);
      });
    });

  </script>
</body>
</html>
